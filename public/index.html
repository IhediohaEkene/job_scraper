<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Job Aggregator - Multi-Source Job Feed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --primary: #0a0e27;
        --secondary: #1f2937;
        --accent: #3b82f6;
        --accent-light: #60a5fa;
        --bg: #ffffff;
        --bg-alt: #f9fafb;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --border: #e5e7eb;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.08);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background-color: var(--bg-alt);
        color: var(--text-primary);
        line-height: 1.6;
      }

      .page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
      }

      header {
        background: var(--bg);
        border-bottom: 1px solid var(--border);
        padding: 1.5rem 0;
        margin-bottom: 2rem;
        box-shadow: var(--shadow);
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1.5rem;
      }

      h1 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 0.5rem;
      }

      .subtitle {
        font-size: 0.95rem;
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
      }

      .header-stats {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
      }

      .stat {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent);
      }

      .stat-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .controls {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .control {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .control label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      input,
      select {
        padding: 0.75rem 1rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.95rem;
        font-family: inherit;
        background-color: var(--bg);
        color: var(--text-primary);
        transition: all 0.2s;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .jobs {
        display: grid;
        gap: 1rem;
      }

      .job-card {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.2s;
        box-shadow: var(--shadow);
        display: flex;
        gap: 1rem;
      }

      .job-source-badge {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        background-color: var(--accent);
        color: white;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.9rem;
        min-width: 80px;
        text-align: center;
        flex-shrink: 0;
      }

      .job-source-badge.telegram {
        background: linear-gradient(135deg, #0088cc, #0077b5);
      }

      .job-source-badge.reddit {
        background: linear-gradient(135deg, #ff4500, #ff6b35);
      }

      .job-content {
        flex: 1;
      }

      .job-card:hover {
        box-shadow: var(--shadow-lg);
        border-color: var(--accent-light);
        transform: translateY(-2px);
      }

      .job-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 0.75rem;
      }

      .meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        padding: 0.35rem 0.75rem;
        background-color: var(--accent);
        color: white;
        border-radius: 999px;
        font-weight: 500;
        font-size: 0.8rem;
      }

      .body {
        font-size: 0.95rem;
        color: var(--text-primary);
        line-height: 1.6;
        margin-bottom: 1rem;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 120px;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
      }

      .phone {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--accent);
        margin-bottom: 0.75rem;
      }

      .actions {
        display: flex;
        gap: 0.75rem;
      }

      a {
        display: inline-flex;
        align-items: center;
        padding: 0.6rem 1rem;
        background-color: var(--accent);
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.9rem;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
      }

      a:hover {
        background-color: var(--accent-light);
        transform: translateX(2px);
      }

      button {
        padding: 0.75rem 1.5rem;
        background-color: var(--accent);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      button:hover {
        background-color: var(--accent-light);
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg);
      }

      .empty {
        text-align: center;
        padding: 3rem 1.5rem;
        color: var(--text-secondary);
      }

      @media (max-width: 768px) {
        h1 {
          font-size: 1.5rem;
        }

        .controls {
          grid-template-columns: 1fr;
        }

        .header-stats {
          gap: 1.5rem;
        }

        .job-card {
          padding: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-content">
        <h1>Job Opportunities</h1>
        <p class="subtitle">Discover jobs from Reddit, Telegram, and more in one place</p>
        <div class="header-stats">
          <div class="stat">
            <span class="stat-value" id="jobCount">0</span>
            <span class="stat-label">Total Jobs</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="subCount">0</span>
            <span class="stat-label">Sources</span>
          </div>
        </div>
      </div>
    </header>

    <div class="page">
      <section class="controls">
        <div class="control">
          <label>Search</label>
          <input id="searchInput" type="search" placeholder="Find a role or keyword..." />
        </div>
        <div class="control">
          <label>Source</label>
          <select id="subFilter">
            <option value="">All Sources</option>
          </select>
        </div>
        <div class="control">
          <label>Time Filter</label>
          <select id="timeFilter">
            <option value="">All Time</option>
            <option value="24h">Last 24 Hours</option>
          </select>
        </div>
        <div class="control">
          <label>Sort</label>
          <select id="sortSelect">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
          </select>
        </div>
      </section>

      <div id="jobs" class="jobs"></div>
      <div id="emptyState" class="empty" style="display: none;">
        No jobs found. Try adjusting your filters.
      </div>
    </div>

    <script>
      const jobsContainer = document.getElementById('jobs');
      const emptyState = document.getElementById('emptyState');
      const subFilter = document.getElementById('subFilter');
      const searchInput = document.getElementById('searchInput');
      const sortSelect = document.getElementById('sortSelect');
      const timeFilter = document.getElementById('timeFilter');
      const jobCount = document.getElementById('jobCount');
      const subCount = document.getElementById('subCount');

      let allJobs = [];

      async function fetchJobs() {
        try {
          const res = await fetch('/api/jobs');
          const data = await res.json();
          allJobs = Array.isArray(data) ? data : [];
          populateFilter();
          renderJobs();
        } catch (err) {
          console.error('Error fetching jobs:', err);
        }
      }

      function populateFilter() {
        const subs = [...new Set(allJobs.map((j) => j.subreddit).filter(Boolean))].sort();
        const currentValue = subFilter.value;
        subFilter.innerHTML = '<option value="">All Sources</option>' +
          subs.map((s) => `<option value="${s}">${formatSource(s)}</option>`).join('');
        subFilter.value = currentValue;
        subCount.textContent = String(subs.length);
      }

      function formatSource(source) {
        if (source.startsWith('telegram/')) {
          return 'üì± ' + source.replace('telegram/', '');
        }
        return 'üîó ' + source;
      }

      function normalize(text) {
        return (text || '').toLowerCase();
      }

      function renderJobs() {
        const filterSub = subFilter.value;
        const query = normalize(searchInput.value);
        const sortOrder = sortSelect.value;
        const timeFilterValue = timeFilter.value;
        let jobs = allJobs.slice();

        // Remove duplicates based on title
        const seen = new Set();
        jobs = jobs.filter((job) => {
          const key = normalize(job.title || '');
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });

        if (filterSub) {
          jobs = jobs.filter((j) => j.subreddit === filterSub);
        }

        if (query) {
          jobs = jobs.filter((j) => {
            return (
              normalize(j.title).includes(query) ||
              normalize(j.body).includes(query)
            );
          });
        }

        // Filter by time
        if (timeFilterValue === '24h') {
          const now = Date.now();
          const oneDayMs = 24 * 60 * 60 * 1000;
          jobs = jobs.filter((j) => {
            const jobDate = new Date(j.createdAt || 0).getTime();
            return (now - jobDate) <= oneDayMs;
          });
        }

        jobs.sort((a, b) => {
          const delta = new Date(a.createdAt || 0) - new Date(b.createdAt || 0);
          return sortOrder === 'oldest' ? delta : -delta;
        });

        jobCount.textContent = String(jobs.length);
        jobsContainer.innerHTML = '';

        if (jobs.length === 0) {
          emptyState.style.display = 'block';
          return;
        } else {
          emptyState.style.display = 'none';
        }

        jobs.forEach((job) => {
          const card = document.createElement('div');
          card.className = 'job-card';

          // Source Badge
          const sourceBadge = document.createElement('div');
          const isReddit = !job.subreddit || !job.subreddit.includes('telegram');
          const sourceType = isReddit ? 'reddit' : 'telegram';
          sourceBadge.className = `job-source-badge ${sourceType}`;
          sourceBadge.textContent = isReddit ? 'Reddit' : 'Telegram';

          // Content wrapper
          const content = document.createElement('div');
          content.className = 'job-content';

          const title = document.createElement('div');
          title.className = 'job-title';
          title.textContent = job.title || '(No title)';

          const meta = document.createElement('div');
          meta.className = 'meta';

          const created = job.createdAt ? new Date(job.createdAt).toLocaleDateString() : '';
          const time = document.createElement('span');
          time.textContent = created;
          time.style.fontSize = '0.85rem';
          time.style.color = 'var(--text-secondary)';

          if (created) meta.appendChild(time);

          const body = document.createElement('div');
          body.className = 'body';
          const snippet = (job.body || '').trim().slice(0, 280);
          body.textContent = snippet ? `${snippet}${snippet.length >= 280 ? '...' : ''}` : '';

          const phone = document.createElement('div');
          phone.className = 'phone';
          phone.textContent = job.phone ? `‚òéÔ∏è  ${job.phone}` : '';

          const actions = document.createElement('div');
          actions.className = 'actions';

          const link = document.createElement('a');
          link.href = job.permalink || job.url || '#';
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.textContent = 'View Details ‚Üí';

          actions.appendChild(link);

          content.appendChild(title);
          content.appendChild(meta);
          if (job.body) content.appendChild(body);
          if (job.phone) content.appendChild(phone);
          content.appendChild(actions);

          card.appendChild(sourceBadge);
          card.appendChild(content);

          jobsContainer.appendChild(card);
        });
      }

      subFilter.addEventListener('change', renderJobs);
      sortSelect.addEventListener('change', renderJobs);
      timeFilter.addEventListener('change', renderJobs);
      searchInput.addEventListener('input', renderJobs);

      fetchJobs();
      setInterval(fetchJobs, 30000);
    </script>
  </body>
</html>
